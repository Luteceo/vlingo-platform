# Deploy to Pivotal Cloud Foundry

## Docker

The first we need to do is to generate a docker image and push it to any registry.
We will use the [DockerHub](https://hub.docker.com) registry for this example.

> You can use any Docker Registry that you want, either DockerHub, any private Docker Registry or GCR. If you want more information of how to deploy from any of this registries you should check this [link](https://docs.cloudfoundry.org/devguide/deploy-apps/push-docker.html)

### Docker Image Publish

1. Register to [DockerHub](https://hub.docker.com/register/)
2. Once we are logged in, we need to [create a repository](https://hub.docker.com/add/repository/) for each image (the field **Name** is the name of the docker image, this is the identifier along with the account name)
3. After that, you should login to the registry with your [docker cli](https://docs.docker.com/engine/reference/commandline/login/) just writing `docker login` in your shell.
4. Now you are ready to push your image to DockerHub repository using `docker-release.sh`

        ```./docker-release.sh <account_name/name>```

Once the script finishes, the docker image is published to DockerHub and ready to be deployed.

#### Docker Image Implementation

The Dockerfile is implemented using MultiStage build:

- The build stage extends `FROM maven:alpine`, the only responsability of this stage is to install dependencies (caching layers) and generate the jar.
- The runtime stage extends `FROM openjdk:alpine` and works executing the jar generated by build stage. It `EXPOSE` the external ports to the host.


## Pivotal CloudFoundry

Now that we have our images pushed to DockerHub, we can now focus on push them into Pivotal Platform.

The first requirement we have is to create an account in [Pivotal](https://pivotal.io/get-started).
When you get access to your console, you should create an organization manually. It's simple as fill an input inside *Create an Org*.

Next step is to install the CF CLI in our computer. You have a guide to do it in your platform in [PCF CLI Install](https://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry/install-the-cf-cli)

Once we have CF CLI installed in our machine, you can now login to your Pivotal account:

    $ cf login -a https://api.run.pivotal.io

Now you have connected your CF CLI with your account of Pivotal, you should copy the `example-manifest.yml` inside your project and rename it to `manifest.yml`.
Inside of the manifest file there are only three variables to configure:
1. service_name: It's the name of our service inside the Pivotal Cloud Foundry platform.
2. docker_image: The docker image name is composed of your account and the repository (e.g: vlingo/project1)
3. subdomain: This will be your public endpoint within domain `.cfapps.io`

You can also configure things like env vars, instances, memory, disk quota, etc. You can go to the [Deploying with Application Manifests](https://docs.cloudfoundry.org/devguide/deploy-apps/manifest.html) and check the possibilites you have using manifest.

Once you have your `manifest.yml` configured to your project, you only need to push it:

    $ cf push

 > This command by default check if any manifest.yml exists in the directory and use it to push to the platform.

That's all, our application is in the Pivotal Cloud Foundry deployed and working. You can go to the Pivotal Console and see the services you have, the logs, anything about your project infrastructure.

You can see in the [vlingo examples repository](https://github.com/vlingo/vlingo-examples) a working configuration and you can see how can communicate two or more services between them inside Pivotal Cloud Foundry platform.
